'use client';

import { useState, useEffect } from 'react';
// import ChatInterface from "@/components/ui/chat-interface";
import WelcomePage from "@/components/WelcomePage";
import GameIntro from "@/components/GameIntro";
import useWorldWalletAuth from "@/hooks/useWorldWalletAuth";
import TerminalChat from "@/components/TerminalChat";
import LanguageSelectionScreen from "@/components/LanguageSelectionScreen";
import LanguageSelectorClient from "@/components/LanguageSelectorClient";
import { useLanguage } from '@/contexts/LanguageContext';
import LanguageDebug from "@/components/LanguageDebug";
import NotificationPermissionManager from "@/components/NotificationPermissionManager";
import "@/utils/notificationDebugger"; // Pour exposer NotificationDebugger globalement

export default function Home() {
  const { t } = useLanguage();
  const { isAuthenticated, isLoading, login, user } = useWorldWalletAuth();
  const [authError, setAuthError] = useState<string | null>(null);
  const [showWelcome, setShowWelcome] = useState(false);
  const [showIntro, setShowIntro] = useState(true);
  const [fragments, setFragments] = useState(0);
  const [languageSelected, setLanguageSelected] = useState<boolean | null>(null);

  // V√©rifier si une langue a √©t√© s√©lectionn√©e
  useEffect(() => {
    const hasSelectedLanguage = localStorage.getItem('language-selected') === 'true';
    setLanguageSelected(hasSelectedLanguage);
  }, []);

  // Debug des √©tats d'authentification
  useEffect(() => {
    console.log('üè† [Page] √âtat d\'authentification:', {
      isAuthenticated,
      isLoading,
      hasUser: !!user,
      userWallet: user?.walletAddress,
      username: user?.worldUsername,
      showWelcome,
      showIntro,
      languageSelected
    });
  }, [isAuthenticated, isLoading, user, showWelcome, showIntro, languageSelected]);

  // Fermer automatiquement la WelcomePage apr√®s authentification (TEMPORAIRE pour debug)
  useEffect(() => {
    if (isAuthenticated && user && showWelcome) {
      console.log('üîÑ [Page] Utilisateur authentifi√© - fermeture automatique de WelcomePage dans 3 secondes');
      const timer = setTimeout(() => {
        console.log('üöÄ [Page] Fermeture forc√©e de WelcomePage');
        setShowWelcome(false);
      }, 3000); // 3 secondes pour voir la modal de notification

      return () => clearTimeout(timer);
    }
  }, [isAuthenticated, user, showWelcome]);

  const handleAuthSuccess = (user: any, token: string) => {
    console.log('üéâ [Page] Authentification r√©ussie:', {
      userId: user.userId,
      walletAddress: user.walletAddress,
      worldUsername: user.worldUsername
    });
    
    login(user, token);
    setAuthError(null);
    console.log('üîÑ [Page] setShowWelcome(true) appel√© apr√®s authentification');
    setShowWelcome(true);
  };

  const handleAuthError = (error: string) => {
    console.error('‚ùå [Page] Erreur d\'authentification:', error);
    setAuthError(error);
  };

  const handleWelcomeComplete = () => {
    console.log('‚úÖ [Page] handleWelcomeComplete appel√© - fermeture de WelcomePage');
    setShowWelcome(false);
  };

  const handleIntroComplete = () => {
    console.log('‚úÖ [Page] Intro termin√©e, passage √† l\'authentification');
    setShowIntro(false);
    setShowWelcome(true);
  };

  const handleLanguageSelected = (langCode: string) => {
    console.log('üåç [Page] Langue s√©lectionn√©e:', langCode);
    // Mettre √† jour l'√©tat pour cacher l'√©cran de s√©lection
    setLanguageSelected(true);
  };

  // Si on charge encore les donn√©es d'authentification ou de langue
  if (isLoading || languageSelected === null) {
    return (
      <div className="min-h-screen bg-gradient-to-br from-gray-900 via-purple-900 to-blue-900 flex items-center justify-center">
        <div className="text-white text-xl">
          {t('auth.loadingApp')}
        </div>
      </div>
    );
  }

  // 0. TOUJOURS afficher la s√©lection de langue en premier si elle n'a pas √©t√© faite
  if (!languageSelected) {
    console.log('üåç [Page] Affichage de LanguageSelectionScreen');
    return <LanguageSelectionScreen onLanguageSelected={handleLanguageSelected} />;
  }

  // 1. Toujours afficher l'intro d'abord
  if (showIntro) {
    console.log('üé¨ [Page] Affichage de GameIntro');
    return <GameIntro onComplete={handleIntroComplete} />;
  }

  // 2. Ensuite la page de bienvenue / authentification
  if (showWelcome || !isAuthenticated) {
    console.log('üëã [Page] Affichage de WelcomePage (showWelcome:', showWelcome, ', isAuthenticated:', isAuthenticated, ')');
    return (
      <div>
        <WelcomePage 
          onComplete={handleWelcomeComplete}
          onAuthSuccess={handleAuthSuccess}
          onAuthError={handleAuthError}
        />
        
        {/* Gestionnaire de notifications TEMPORAIRE sur WelcomePage pour debug */}
        {isAuthenticated && user && (
          <NotificationPermissionManager
            forceShow={true}  // TEMPORAIRE - pour debug
            delay={500}
            onPermissionHandled={(granted) => {
              console.log('üîî [Page] Permission de notification:', granted ? 'accord√©e' : 'refus√©e');
            }}
          />
        )}
      </div>
    );
  }

  // 3. Enfin, une fois authentifi√© et apr√®s la page de bienvenue, afficher le terminal
  if (isAuthenticated && user) {
    console.log('üéØ [Page] Affichage de TerminalChat (isAuthenticated:', isAuthenticated, ', user:', !!user, ', showWelcome:', showWelcome, ')');
    return (
      <div className="min-h-screen bg-black relative overflow-hidden">
        <img
          src="/kaelen_sit.png"
          alt="Kaelen background"
          className="fixed top-0 left-0 w-screen h-screen object-cover object-center brightness-90 blur-[2px] -z-10"
        />
        <LanguageSelectorClient />
        <LanguageDebug />
        
        {/* Gestionnaire des permissions de notifications - affichage forc√© pour debug */}
        <NotificationPermissionManager
          forceShow={true}  // TEMPORAIRE - pour debug
          delay={500}
          onPermissionHandled={(granted) => {
            console.log('üîî [Page] Permission de notification:', granted ? 'accord√©e' : 'refus√©e');
          }}
        />
        
        <TerminalChat 
          fragments={fragments} 
          onFragmentsUpdate={setFragments}
          onPurchaseRequest={() => {}}
          onSubTerminalToggle={() => {}}
          userAddr={user.walletAddress}
        />
      </div>
    );
  }

  // Fallback - normalement on ne devrait jamais arriver ici
  console.warn('‚ö†Ô∏è [Page] √âtat inattendu, retour √† l\'intro (isAuthenticated:', isAuthenticated, ', user:', !!user, ', showWelcome:', showWelcome, ', showIntro:', showIntro, ')');
  return <GameIntro onComplete={handleIntroComplete} />;
}
